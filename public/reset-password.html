<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reset Password - Online Banking</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <!-- Navigation -->
  <nav>
    <a href="index.html">Home</a>
    <a href="login.html">Login</a>
  </nav>

  <!-- Reset Password Section -->
  <main>
    <section class="form-container">
      <h2>Reset Password</h2>
      <p>Enter your new password below.</p>
      
      <form id="resetPasswordForm">
        <label for="password">New Password</label>
        <div class="password-container">
          <input type="password" id="password" placeholder="Enter new password" required />
          <button type="button" id="togglePassword">ğŸ‘ï¸</button>
        </div>
        
        <div id="passwordCriteria" class="password-criteria">
          <h4>Password Requirements:</h4>
          <ul>
            <li id="lengthCheck">âŒ At least 8 characters</li>
            <li id="lowercaseCheck">âŒ At least one lowercase letter (a-z)</li>
            <li id="uppercaseCheck">âŒ At least one uppercase letter (A-Z)</li>
            <li id="numberCheck">âŒ At least one number (0-9)</li>
            <li id="specialCheck">âŒ At least one special character (@$!%*?&)</li>
          </ul>
        </div>
        <p id="passwordStrength" class="info"></p>

        <label for="confirmPassword">Confirm New Password</label>
        <div class="password-container">
          <input type="password" id="confirmPassword" placeholder="Confirm new password" required />
          <button type="button" id="toggleConfirmPassword">ğŸ‘ï¸</button>
        </div>

        <button type="submit">Reset Password</button>
      </form>
      
      <p id="error" class="error"></p>
      <p id="success" class="success"></p>
      
      <div class="form-links">
        <a href="login.html">â† Back to Login</a>
      </div>
    </section>
  </main>

  <!-- JavaScript Logic -->
  <script>
    // Get token from URL
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    
    if (!token) {
      document.getElementById('error').textContent = 'âŒ Invalid reset link. Please request a new password reset.';
      document.getElementById('resetPasswordForm').style.display = 'none';
    }

    // Password visibility toggles
    document.getElementById('togglePassword')?.addEventListener('click', function () {
      const passwordField = document.getElementById('password');
      const toggleButton = document.getElementById('togglePassword');
      
      if (passwordField.type === 'password') {
        passwordField.type = 'text';
        toggleButton.textContent = 'ğŸ™ˆ';
      } else {
        passwordField.type = 'password';
        toggleButton.textContent = 'ğŸ‘ï¸';
      }
    });

    document.getElementById('toggleConfirmPassword')?.addEventListener('click', function () {
      const passwordField = document.getElementById('confirmPassword');
      const toggleButton = document.getElementById('toggleConfirmPassword');
      
      if (passwordField.type === 'password') {
        passwordField.type = 'text';
        toggleButton.textContent = 'ğŸ™ˆ';
      } else {
        passwordField.type = 'password';
        toggleButton.textContent = 'ğŸ‘ï¸';
      }
    });

    // Password validation function
    function validatePassword(password) {
      const regex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;
      return regex.test(password);
    }

    // Password strength indicator
    document.getElementById('password').addEventListener('input', function () {
      const password = this.value;
      const strengthMessage = document.getElementById('passwordStrength');
      
      // Check each criteria
      const hasLength = password.length >= 8;
      const hasLowercase = /[a-z]/.test(password);
      const hasUppercase = /[A-Z]/.test(password);
      const hasNumber = /\d/.test(password);
      const hasSpecial = /[@$!%*?&]/.test(password);
      
      // Update visual indicators
      document.getElementById('lengthCheck').textContent = (hasLength ? 'âœ…' : 'âŒ') + ' At least 8 characters';
      document.getElementById('lowercaseCheck').textContent = (hasLowercase ? 'âœ…' : 'âŒ') + ' At least one lowercase letter (a-z)';
      document.getElementById('uppercaseCheck').textContent = (hasUppercase ? 'âœ…' : 'âŒ') + ' At least one uppercase letter (A-Z)';
      document.getElementById('numberCheck').textContent = (hasNumber ? 'âœ…' : 'âŒ') + ' At least one number (0-9)';
      document.getElementById('specialCheck').textContent = (hasSpecial ? 'âœ…' : 'âŒ') + ' At least one special character (@$!%*?&)';
      
      // Overall strength message
      if (password.length === 0) {
        strengthMessage.textContent = '';
        strengthMessage.style.color = '';
      } else if (validatePassword(password)) {
        strengthMessage.textContent = 'âœ… Password meets all requirements!';
        strengthMessage.style.color = 'green';
      } else {
        const missing = [];
        if (!hasLength) missing.push('length');
        if (!hasLowercase) missing.push('lowercase');
        if (!hasUppercase) missing.push('uppercase');
        if (!hasNumber) missing.push('number');
        if (!hasSpecial) missing.push('special character');
        
        strengthMessage.textContent = `âŒ Missing: ${missing.join(', ')}`;
        strengthMessage.style.color = 'red';
      }
    });

    // Form submission
    document.getElementById('resetPasswordForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      // Clear previous messages
      document.getElementById('error').textContent = '';
      document.getElementById('success').textContent = '';

      // Validate passwords
      if (!validatePassword(password)) {
        document.getElementById('error').textContent = 'âŒ Password does not meet all requirements.';
        return;
      }

      if (password !== confirmPassword) {
        document.getElementById('error').textContent = 'âŒ Passwords do not match.';
        return;
      }

      try {
        const response = await fetch('/api/reset-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token, password }),
        });

        const data = await response.json();
        
        if (response.ok) {
          document.getElementById('success').textContent = 'âœ… ' + data.message + ' Redirecting to login...';
          document.getElementById('resetPasswordForm').style.display = 'none';
          setTimeout(() => {
            window.location.href = 'login.html';
          }, 2000);
        } else {
          document.getElementById('error').textContent = 'âŒ ' + data.message;
        }
      } catch (error) {
        console.error('Reset password error:', error);
        document.getElementById('error').textContent = 'âŒ Server error. Please try again.';
      }
    });
  </script>

</body>
</html>
