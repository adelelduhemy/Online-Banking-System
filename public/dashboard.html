<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - Online Banking</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <!-- Navigation -->
  <nav>
    <div class="nav-left">
      <a href="index.html">ğŸ¦ <strong>OnlineBank</strong></a>
    </div>
    <div class="nav-right">
      <a href="index.html">ğŸ  Home</a>
      <button id="logout">ğŸšª Logout</button>
    </div>
  </nav>

  <!-- Dashboard Content -->
  <main>
    <section class="dashboard">
      <h1>ğŸ’¼ Dashboard</h1>

      <!-- User Info -->
      <div class="user-info">
        <p>ğŸ‘‹ Welcome back, <span id="userName"></span>!</p>
        <p>ğŸ¦ Account Number: <span id="accountNumber"></span></p>
        <p>ğŸ’° Checking Balance: $<span id="balance"></span></p>
        <p>ğŸ’³ Savings Balance: $<span id="savingsBalance"></span></p>
      </div>

      <!-- Quick Actions -->
      <div class="quick-actions">
        <button class="action-btn" onclick="showDepositModal()">ğŸ’° Deposit</button>
        <button class="action-btn" onclick="showWithdrawModal()">ğŸ’¸ Withdraw</button>
        <button class="action-btn" onclick="showTransferModal()">ğŸ”„ Transfer</button>
        <button class="action-btn" onclick="showCategories()">ğŸ“Š Categories</button>
      </div>

      <!-- Features -->
      <div class="features">

        <!-- Account Summary -->
        <section class="feature">
          <h2>ğŸ“Š Account Summary</h2>
          <div id="accountSummary">
            <div class="summary-card">
              <h3>Recent Activity</h3>
              <div id="recentActivity">Loading...</div>
            </div>
            <div class="summary-card">
              <h3>Spending by Category</h3>
              <div id="spendingChart">Loading...</div>
            </div>
          </div>
        </section>

        <!-- Transaction History -->
        <section class="feature">
          <h2>ğŸ“œ Transaction History</h2>
          <div class="transaction-filters">
            <select id="categoryFilter">
              <option value="">All Categories</option>
            </select>
            <select id="typeFilter">
              <option value="">All Types</option>
              <option value="transfer">Transfer</option>
              <option value="deposit">Deposit</option>
              <option value="withdrawal">Withdrawal</option>
              <option value="payment">Payment</option>
            </select>
          </div>
          <ul id="transactionHistory">
            <li>â³ Loading transactions...</li>
          </ul>
        </section>

      </div>
    </section>
  </main>

  <!-- Deposit Modal -->
  <div id="depositModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('depositModal')">&times;</span>
      <h2>ğŸ’° Deposit Money</h2>
      <form id="depositForm">
        <label for="depositAmount">Amount ($)</label>
        <input type="number" id="depositAmount" placeholder="Enter amount" step="0.01" min="0.01" required />
        
        <label for="depositMethod">Method</label>
        <select id="depositMethod">
          <option value="online">Online</option>
          <option value="bank_transfer">Bank Transfer</option>
          <option value="check">Check</option>
        </select>
        
        <label for="depositDescription">Description</label>
        <input type="text" id="depositDescription" placeholder="Optional description" />
        
        <button type="submit">ğŸ’° Deposit</button>
      </form>
    </div>
  </div>

  <!-- Withdraw Modal -->
  <div id="withdrawModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('withdrawModal')">&times;</span>
      <h2>ğŸ’¸ Withdraw Money</h2>
      <form id="withdrawForm">
        <label for="withdrawAmount">Amount ($)</label>
        <input type="number" id="withdrawAmount" placeholder="Enter amount" step="0.01" min="0.01" required />
        
        <label for="withdrawMethod">Method</label>
        <select id="withdrawMethod">
          <option value="online">Online</option>
          <option value="bank_transfer">Bank Transfer</option>
          <option value="cash">Cash</option>
        </select>
        
        <label for="withdrawDescription">Description</label>
        <input type="text" id="withdrawDescription" placeholder="Optional description" />
        
        <button type="submit">ğŸ’¸ Withdraw</button>
      </form>
    </div>
  </div>

  <!-- Transfer Modal -->
  <div id="transferModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('transferModal')">&times;</span>
      <h2>ğŸ”„ Transfer Money</h2>
      <form id="transferForm">
        <label for="recipient">Recipient Account Number</label>
        <input type="text" id="recipient" placeholder="Enter account number" required />
        
        <label for="amount">Amount ($)</label>
        <input type="number" id="amount" placeholder="Enter amount" step="0.01" min="0.01" required />
        
        <label for="transferCategory">Category</label>
        <select id="transferCategory">
          <option value="other">Other</option>
        </select>
        
        <label for="transferDescription">Description</label>
        <input type="text" id="transferDescription" placeholder="Optional description" />
        
        <button type="submit">ğŸš€ Send Transfer</button>
      </form>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    const token = localStorage.getItem('token');
    const user = JSON.parse(localStorage.getItem('user'));

    if (!user || !token) {
      alert('âŒ You must log in first.');
      window.location.href = 'login.html';
    } else {
      // Session Management - Auto logout after 30 minutes of inactivity
      let lastActivity = Date.now();
      const SESSION_TIMEOUT = 30 * 60 * 1000; // 30 minutes
      
      // Update last activity on user interaction
      function updateActivity() {
        lastActivity = Date.now();
      }
      
      // Check for inactivity every minute
      setInterval(() => {
        if (Date.now() - lastActivity > SESSION_TIMEOUT) {
          alert('â° Session expired due to inactivity. Please log in again.');
          localStorage.removeItem('token');
          localStorage.removeItem('user');
          window.location.href = 'login.html';
        }
      }, 60000); // Check every minute
      
      // Add event listeners for user activity
      ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'].forEach(event => {
        document.addEventListener(event, updateActivity, true);
      });

      // Initialize dashboard
      initializeDashboard();
    }

    async function initializeDashboard() {
      try {
        // Load account summary
        const summaryResponse = await fetch('/api/account-summary', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const summary = await summaryResponse.json();
        
        // Update user info
        document.getElementById('userName').textContent = user.name;
        document.getElementById('accountNumber').textContent = summary.accountNumber;
        document.getElementById('balance').textContent = summary.balance.toFixed(2);
        document.getElementById('savingsBalance').textContent = (summary.savingsBalance || 0).toFixed(2);

        // Load transaction categories
        await loadTransactionCategories();
        
        // Load recent activity
        displayRecentActivity(summary.recentTransactions);
        
        // Load spending chart
        displaySpendingChart(summary.spendingByCategory);
        
        // Load transactions
        await loadTransactions();
        
      } catch (error) {
        console.error('Dashboard initialization error:', error);
      }
    }

    async function loadTransactionCategories() {
      try {
        const response = await fetch('/api/transaction-categories', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const categories = await response.json();
        
        // Populate category filters
        const categoryFilter = document.getElementById('categoryFilter');
        const transferCategory = document.getElementById('transferCategory');
        
        categories.forEach(category => {
          const option1 = new Option(category.label, category.value);
          const option2 = new Option(category.label, category.value);
          categoryFilter.add(option1);
          transferCategory.add(option2);
        });
      } catch (error) {
        console.error('Error loading categories:', error);
      }
    }

    function displayRecentActivity(transactions) {
      const container = document.getElementById('recentActivity');
      if (!transactions || transactions.length === 0) {
        container.innerHTML = '<p>No recent activity</p>';
        return;
      }
      
      container.innerHTML = transactions.map(tx => `
        <div class="activity-item">
          <span class="activity-icon">${getTransactionIcon(tx.type)}</span>
          <div class="activity-details">
            <p>${tx.description || getTransactionDescription(tx)}</p>
            <small>${new Date(tx.date).toLocaleDateString()}</small>
          </div>
          <span class="activity-amount ${tx.sender === user.accountNumber ? 'negative' : 'positive'}">
            ${tx.sender === user.accountNumber ? '-' : '+'}$${tx.amount.toFixed(2)}
          </span>
        </div>
      `).join('');
    }

    function displaySpendingChart(spendingData) {
      const container = document.getElementById('spendingChart');
      if (!spendingData || spendingData.length === 0) {
        container.innerHTML = '<p>No spending data available</p>';
        return;
      }
      
      const total = spendingData.reduce((sum, item) => sum + item.total, 0);
      
      container.innerHTML = spendingData.map(item => `
        <div class="spending-item">
          <div class="spending-label">
            <span class="spending-category">${getCategoryLabel(item._id)}</span>
            <span class="spending-percentage">${((item.total / total) * 100).toFixed(1)}%</span>
          </div>
          <div class="spending-bar">
            <div class="spending-fill" style="width: ${(item.total / total) * 100}%"></div>
          </div>
          <span class="spending-amount">$${item.total.toFixed(2)}</span>
        </div>
      `).join('');
    }

    async function loadTransactions() {
      try {
        const category = document.getElementById('categoryFilter').value;
        const type = document.getElementById('typeFilter').value;
        
        const params = new URLSearchParams();
        if (category) params.append('category', category);
        if (type) params.append('type', type);
        
        const response = await fetch(`/api/transactions?${params}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const transactions = await response.json();
        
        displayTransactions(transactions);
      } catch (error) {
        console.error('Error loading transactions:', error);
      }
    }

    function displayTransactions(transactions) {
      const list = document.getElementById('transactionHistory');
      if (!transactions || transactions.length === 0) {
        list.innerHTML = '<li>No transactions found.</li>';
        return;
      }
      
      list.innerHTML = transactions.map(tx => `
        <li class="transaction-item">
          <div class="transaction-icon">${getTransactionIcon(tx.type)}</div>
          <div class="transaction-details">
            <p class="transaction-description">${tx.description || getTransactionDescription(tx)}</p>
            <small class="transaction-date">${new Date(tx.date).toLocaleString()}</small>
            <span class="transaction-category">${getCategoryLabel(tx.category)}</span>
          </div>
          <div class="transaction-amount ${tx.sender === user.accountNumber ? 'negative' : 'positive'}">
            ${tx.sender === user.accountNumber ? '-' : '+'}$${tx.amount.toFixed(2)}
          </div>
        </li>
      `).join('');
    }

    // Modal functions
    function showDepositModal() {
      document.getElementById('depositModal').style.display = 'block';
    }

    function showWithdrawModal() {
      document.getElementById('withdrawModal').style.display = 'block';
    }

    function showTransferModal() {
      document.getElementById('transferModal').style.display = 'block';
    }

    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }

    function showCategories() {
      alert('ğŸ“Š Transaction Categories:\n\nğŸ” Food & Dining\nğŸš— Transportation\nğŸ¬ Entertainment\nâš¡ Utilities\nğŸ¥ Healthcare\nğŸ›ï¸ Shopping\nğŸ“š Education\nâœˆï¸ Travel\nğŸ“¦ Other');
    }

    // Form handlers
    document.getElementById('depositForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const amount = parseFloat(document.getElementById('depositAmount').value);
      const method = document.getElementById('depositMethod').value;
      const description = document.getElementById('depositDescription').value;

      console.log('ğŸ’° Frontend deposit attempt:', { amount, method, description });
      console.log('ğŸ”‘ Token available:', !!token);

      if (!amount || amount <= 0) {
        alert('âŒ Please enter a valid amount');
        return;
      }

      try {
        const response = await fetch('/api/deposit', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ amount, method, description })
        });

        console.log('ğŸ“¡ Response status:', response.status);
        const data = await response.json();
        console.log('ğŸ“¡ Response data:', data);

        if (response.ok) {
          alert('âœ… Deposit successful!');
          closeModal('depositModal');
          initializeDashboard();
        } else {
          alert('âŒ ' + data.message);
        }
      } catch (error) {
        console.error('âŒ Deposit error details:', error);
        alert('âŒ Deposit failed. Please try again. Check console for details.');
      }
    });

    document.getElementById('withdrawForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const amount = parseFloat(document.getElementById('withdrawAmount').value);
      const method = document.getElementById('withdrawMethod').value;
      const description = document.getElementById('withdrawDescription').value;

      try {
        const response = await fetch('/api/withdraw', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ amount, method, description })
        });

        const data = await response.json();
        if (response.ok) {
          alert('âœ… Withdrawal successful!');
          closeModal('withdrawModal');
          initializeDashboard();
        } else {
          alert('âŒ ' + data.message);
        }
      } catch (error) {
        console.error('Withdrawal error:', error);
        alert('âŒ Withdrawal failed. Please try again.');
      }
    });

    document.getElementById('transferForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const recipient = document.getElementById('recipient').value;
      const amount = parseFloat(document.getElementById('amount').value);
      const category = document.getElementById('transferCategory').value;
      const description = document.getElementById('transferDescription').value;

      try {
        const response = await fetch('/api/transfer', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ recipient, amount, category, description })
        });

        const data = await response.json();
        if (response.ok) {
          alert('âœ… Transfer successful!');
          closeModal('transferModal');
          initializeDashboard();
        } else {
          alert('âŒ ' + data.message);
        }
      } catch (error) {
        console.error('Transfer error:', error);
        alert('âŒ Transfer failed. Please try again.');
      }
    });

    // Filter change handlers
    document.getElementById('categoryFilter').addEventListener('change', loadTransactions);
    document.getElementById('typeFilter').addEventListener('change', loadTransactions);

    // Helper functions
    function getTransactionIcon(type) {
      const icons = {
        'transfer': 'ğŸ”„',
        'deposit': 'ğŸ’°',
        'withdrawal': 'ğŸ’¸',
        'payment': 'ğŸ’³',
        'refund': 'â†©ï¸',
        'fee': 'ğŸ’¸'
      };
      return icons[type] || 'ğŸ’µ';
    }

    function getTransactionDescription(tx) {
      if (tx.type === 'deposit') return 'Deposit';
      if (tx.type === 'withdrawal') return 'Withdrawal';
      if (tx.type === 'transfer') return `Transfer to ${tx.recipient}`;
      return tx.type;
    }

    function getCategoryLabel(category) {
      const labels = {
        'food': 'ğŸ” Food',
        'transportation': 'ğŸš— Transport',
        'entertainment': 'ğŸ¬ Entertainment',
        'utilities': 'âš¡ Utilities',
        'healthcare': 'ğŸ¥ Healthcare',
        'shopping': 'ğŸ›ï¸ Shopping',
        'education': 'ğŸ“š Education',
        'travel': 'âœˆï¸ Travel',
        'other': 'ğŸ“¦ Other'
      };
      return labels[category] || 'ğŸ“¦ Other';
    }

    // Logout
    document.getElementById('logout').addEventListener('click', () => {
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      window.location.href = 'login.html';
    });

    // Close modals when clicking outside
    window.onclick = function(event) {
      const modals = document.querySelectorAll('.modal');
      modals.forEach(modal => {
        if (event.target === modal) {
          modal.style.display = 'none';
        }
      });
    }
  </script>

</body>
</html>
