<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Panel - Online Banking</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <!-- Navigation -->
  <nav>
    <div class="nav-left">
      <a href="index.html">🏦 <strong>OnlineBank</strong> Admin</a>
    </div>
    <div class="nav-right">
      <a href="dashboard.html">💼 Dashboard</a>
      <button id="logout">🚪 Logout</button>
    </div>
  </nav>

  <!-- Admin Content -->
  <main>
    <section class="dashboard">
      <h1>🔧 Admin Panel</h1>
      <p style="text-align: center; color: var(--text-secondary); margin-bottom: 2rem;">Manage users, transactions, and system settings</p>

      <!-- Admin Stats -->
      <div class="admin-stats">
        <div class="stat-card">
          <h3>👥 Total Users</h3>
          <div class="stat-number" id="totalUsers">-</div>
        </div>
        <div class="stat-card">
          <h3>✅ Active Users</h3>
          <div class="stat-number" id="activeUsers">-</div>
        </div>
        <div class="stat-card">
          <h3>💳 Total Transactions</h3>
          <div class="stat-number" id="totalTransactions">-</div>
        </div>
        <div class="stat-card">
          <h3>💰 Total Volume</h3>
          <div class="stat-number" id="totalVolume">-</div>
        </div>
      </div>

      <!-- Admin Tabs -->
      <div class="admin-tabs">
        <button class="tab-btn active" onclick="showTab('users')">👥 Users</button>
        <button class="tab-btn" onclick="showTab('transactions')">💳 Transactions</button>
        <button class="tab-btn" onclick="showTab('settings')">⚙️ Settings</button>
      </div>

      <!-- Users Tab -->
      <div id="usersTab" class="tab-content active">
        <h2>👥 User Management</h2>
        <div class="table-container">
          <table id="usersTable">
            <thead>
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Account #</th>
                <th>Balance</th>
                <th>Status</th>
                <th>Last Activity</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              <tr>
                <td colspan="7">Loading users...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Transactions Tab -->
      <div id="transactionsTab" class="tab-content">
        <h2>💳 Transaction Management</h2>
        <div class="transaction-filters">
          <select id="adminTypeFilter">
            <option value="">All Types</option>
            <option value="transfer">Transfer</option>
            <option value="deposit">Deposit</option>
            <option value="withdrawal">Withdrawal</option>
            <option value="payment">Payment</option>
          </select>
          <select id="adminStatusFilter">
            <option value="">All Status</option>
            <option value="completed">Completed</option>
            <option value="pending">Pending</option>
            <option value="failed">Failed</option>
          </select>
        </div>
        <div class="table-container">
          <table id="transactionsTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>Type</th>
                <th>From</th>
                <th>To</th>
                <th>Amount</th>
                <th>Category</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="transactionsTableBody">
              <tr>
                <td colspan="7">Loading transactions...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Settings Tab -->
      <div id="settingsTab" class="tab-content">
        <h2>⚙️ System Settings</h2>
        <div class="settings-grid">
          <div class="setting-card">
            <h3>🔒 Security Settings</h3>
            <p>Configure security policies and authentication settings</p>
            <button class="setting-btn">Configure</button>
          </div>
          <div class="setting-card">
            <h3>📊 Analytics</h3>
            <p>View system analytics and performance metrics</p>
            <button class="setting-btn">View Analytics</button>
          </div>
          <div class="setting-card">
            <h3>📧 Email Settings</h3>
            <p>Configure email templates and notifications</p>
            <button class="setting-btn">Configure</button>
          </div>
          <div class="setting-card">
            <h3>🔧 System Maintenance</h3>
            <p>Perform system maintenance and updates</p>
            <button class="setting-btn">Maintenance</button>
          </div>
        </div>
      </div>

    </section>
  </main>

  <!-- JavaScript -->
  <script>
    const token = localStorage.getItem('token');
    const user = JSON.parse(localStorage.getItem('user'));

    if (!user || !token || user.role !== 'admin') {
      alert('❌ Access denied. Admin privileges required.');
      window.location.href = 'login.html';
    } else {
      // Initialize admin panel
      initializeAdminPanel();
    }

    async function initializeAdminPanel() {
      try {
        // Load admin stats
        await loadAdminStats();
        
        // Load users
        await loadUsers();
        
        // Load transactions
        await loadTransactions();
        
      } catch (error) {
        console.error('Admin panel initialization error:', error);
      }
    }

    async function loadAdminStats() {
      try {
        const response = await fetch('/api/admin/stats', {
          headers: { 'Authorization': token }
        });
        const stats = await response.json();
        
        document.getElementById('totalUsers').textContent = stats.totalUsers;
        document.getElementById('activeUsers').textContent = stats.activeUsers;
        document.getElementById('totalTransactions').textContent = stats.totalTransactions;
        document.getElementById('totalVolume').textContent = '$' + stats.totalVolume.toFixed(2);
      } catch (error) {
        console.error('Error loading admin stats:', error);
      }
    }

    async function loadUsers() {
      try {
        const response = await fetch('/api/admin/users', {
          headers: { 'Authorization': token }
        });
        const users = await response.json();
        
        const tbody = document.getElementById('usersTableBody');
        tbody.innerHTML = users.map(user => `
          <tr>
            <td>${user.name}</td>
            <td>${user.email}</td>
            <td>${user.accountNumber}</td>
            <td>$${user.balance.toFixed(2)}</td>
            <td>
              <span class="status-badge ${user.isActive ? 'active' : 'inactive'}">
                ${user.isActive ? 'Active' : 'Inactive'}
              </span>
            </td>
            <td>${new Date(user.lastActivity).toLocaleDateString()}</td>
            <td>
              <button class="action-btn-small" onclick="toggleUserStatus('${user._id}', ${user.isActive})">
                ${user.isActive ? 'Deactivate' : 'Activate'}
              </button>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('Error loading users:', error);
      }
    }

    async function loadTransactions() {
      try {
        const type = document.getElementById('adminTypeFilter').value;
        const status = document.getElementById('adminStatusFilter').value;
        
        const params = new URLSearchParams();
        if (type) params.append('type', type);
        if (status) params.append('status', status);
        
        const response = await fetch(`/api/admin/transactions?${params}`, {
          headers: { 'Authorization': token }
        });
        const transactions = await response.json();
        
        const tbody = document.getElementById('transactionsTableBody');
        tbody.innerHTML = transactions.map(tx => `
          <tr>
            <td>${new Date(tx.date).toLocaleDateString()}</td>
            <td>
              <span class="type-badge ${tx.type}">${tx.type}</span>
            </td>
            <td>${tx.sender}</td>
            <td>${tx.recipient}</td>
            <td>$${tx.amount.toFixed(2)}</td>
            <td>${tx.category || 'N/A'}</td>
            <td>
              <span class="status-badge ${tx.status}">${tx.status}</span>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('Error loading transactions:', error);
      }
    }

    async function toggleUserStatus(userId, currentStatus) {
      try {
        const response = await fetch(`/api/admin/users/${userId}/toggle-status`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': token
          }
        });
        
        const data = await response.json();
        if (response.ok) {
          alert('✅ ' + data.message);
          loadUsers(); // Refresh users table
          loadAdminStats(); // Refresh stats
        } else {
          alert('❌ ' + data.message);
        }
      } catch (error) {
        console.error('Error toggling user status:', error);
        alert('❌ Failed to update user status');
      }
    }

    function showTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Remove active class from all buttons
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Show selected tab
      document.getElementById(tabName + 'Tab').classList.add('active');
      
      // Add active class to clicked button
      event.target.classList.add('active');
    }

    // Filter change handlers
    document.getElementById('adminTypeFilter').addEventListener('change', loadTransactions);
    document.getElementById('adminStatusFilter').addEventListener('change', loadTransactions);

    // Logout
    document.getElementById('logout').addEventListener('click', () => {
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      window.location.href = 'login.html';
    });
  </script>

</body>
</html>
